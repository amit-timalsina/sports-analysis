<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ Voice Recording Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-top: 10px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üé§ Voice Recording Debug Tool</h1>
    <p>This tool helps debug voice recording issues step by step.</p>

    <div class="test-section">
        <h2>1. Browser Support Check</h2>
        <div id="browser-support"></div>
    </div>

    <div class="test-section">
        <h2>2. Microphone Permission Test</h2>
        <button onclick="testMicrophoneAccess()">Request Microphone Access</button>
        <div id="mic-status"></div>
    </div>

    <div class="test-section">
        <h2>3. WebSocket Connection Test</h2>
        <button onclick="testWebSocketConnection()">Test WebSocket</button>
        <div id="websocket-status"></div>
    </div>

    <div class="test-section">
        <h2>4. Audio Recording Test</h2>
        <button id="record-btn" onclick="toggleRecording()">Start Recording</button>
        <button onclick="playRecording()" disabled id="play-btn">Play Recording</button>
        <div id="recording-status"></div>
        <audio id="audio-playback" controls style="display: none;"></audio>
    </div>

    <div class="test-section">
        <h2>Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script>
        let mediaRecorder, audioChunks = [], isRecording = false, websocket, recordedAudioBlob;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.textContent = `[${timestamp}] ${message}`;
            entry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function checkBrowserSupport() {
            log('Checking browser support...');
            const features = [];
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                features.push('‚úÖ getUserMedia supported');
            } else {
                features.push('‚ùå getUserMedia NOT supported');
            }
            
            if (window.MediaRecorder) {
                features.push('‚úÖ MediaRecorder supported');
            } else {
                features.push('‚ùå MediaRecorder NOT supported');
            }
            
            if (window.WebSocket) {
                features.push('‚úÖ WebSocket supported');
            } else {
                features.push('‚ùå WebSocket NOT supported');
            }

            if (window.location.protocol === 'https:' || window.location.hostname === 'localhost') {
                features.push('‚úÖ Secure context (HTTPS or localhost)');
            } else {
                features.push('‚ùå Insecure context - microphone access may be blocked');
            }

            document.getElementById('browser-support').innerHTML = features.join('<br>');
            log('Browser support check completed');
        }

        async function testMicrophoneAccess() {
            log('Testing microphone access...');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true, sampleRate: 16000 }
                });
                
                setStatus('mic-status', '‚úÖ Microphone access granted successfully!', 'success');
                log('Microphone access granted', 'success');
                
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const track = audioTracks[0];
                    log(`Audio device: ${track.label || 'Unknown'}`);
                }
                
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                setStatus('mic-status', `‚ùå Microphone access failed: ${error.name} - ${error.message}`, 'error');
                log(`Microphone access failed: ${error.name} - ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('SOLUTION: Click the microphone icon in the address bar and allow microphone access', 'error');
                }
            }
        }

        async function testWebSocketConnection() {
            log('Testing WebSocket connection...');
            
            try {
                const response = await fetch('/api/sessions', { method: 'POST' });
                const sessionData = await response.json();
                
                if (!sessionData.success) {
                    throw new Error('Failed to create session');
                }
                
                const sessionId = sessionData.data.session_id;
                log(`Session created: ${sessionId}`);
                
                const wsUrl = `ws://${window.location.host}/ws/voice/${sessionId}`;
                log(`Connecting to WebSocket: ${wsUrl}`);
                
                const testWs = new WebSocket(wsUrl);
                
                testWs.onopen = function() {
                    setStatus('websocket-status', '‚úÖ WebSocket connected successfully!', 'success');
                    log('WebSocket connection established', 'success');
                    testWs.close();
                };
                
                testWs.onerror = function(error) {
                    setStatus('websocket-status', `‚ùå WebSocket connection failed`, 'error');
                    log(`WebSocket error: ${error}`, 'error');
                };
                
            } catch (error) {
                setStatus('websocket-status', `‚ùå WebSocket test failed: ${error.message}`, 'error');
                log(`WebSocket test failed: ${error.message}`, 'error');
            }
        }

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            log('Starting audio recording...');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true, sampleRate: 16000 }
                });
                
                const mimeTypes = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/wav'];
                let selectedMimeType = '';
                
                for (const mimeType of mimeTypes) {
                    if (MediaRecorder.isTypeSupported(mimeType)) {
                        selectedMimeType = mimeType;
                        log(`Using MIME type: ${mimeType}`);
                        break;
                    }
                }
                
                mediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        log(`Audio chunk received: ${event.data.size} bytes`);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    log('Recording stopped, creating audio blob...');
                    recordedAudioBlob = new Blob(audioChunks, { type: selectedMimeType });
                    log(`Audio blob created: ${recordedAudioBlob.size} bytes`);
                    
                    document.getElementById('play-btn').disabled = false;
                    
                    const audioUrl = URL.createObjectURL(recordedAudioBlob);
                    const audioElement = document.getElementById('audio-playback');
                    audioElement.src = audioUrl;
                    audioElement.style.display = 'block';
                    
                    setStatus('recording-status', `‚úÖ Recording completed! Size: ${recordedAudioBlob.size} bytes`, 'success');
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start(1000);
                isRecording = true;
                
                document.getElementById('record-btn').textContent = 'Stop Recording';
                setStatus('recording-status', 'üî¥ Recording in progress...', 'info');
                log('Recording started successfully', 'success');
                
                setTimeout(() => {
                    if (isRecording) {
                        stopRecording();
                    }
                }, 5000);
                
            } catch (error) {
                setStatus('recording-status', `‚ùå Recording failed: ${error.message}`, 'error');
                log(`Recording failed: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                log('Stopping recording...');
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('record-btn').textContent = 'Start Recording';
            }
        }

        function playRecording() {
            document.getElementById('audio-playback').play();
            log('Playing recorded audio');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            log('Debug tool loaded');
            checkBrowserSupport();
        });
    </script>
</body>
</html>
