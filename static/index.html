<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>🏏 Cricket Fitness Tracker</title>
    <meta name="description" content="Voice-powered cricket fitness tracking for young athletes">
    <meta name="theme-color" content="#4f46e5">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cricket Tracker">
    
    <!-- Mobile-First Styles -->
    <link rel="stylesheet" href="/static/css/mobile-first.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🏏 Cricket Fitness Tracker</h1>
            <p>Voice-powered tracking for young athletes</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="nav-tab" data-tab="analytics">📊 Analytics</button>
            <button class="nav-tab" data-tab="entries">📋 Entries</button>
            <button class="nav-tab" data-tab="chat">🤖 AI Coach</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <!-- Activity Logging Cards -->
            <section class="card">
                <h2>📝 Log Today's Activities</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Tap an activity to start voice logging
                </p>
                
                <div id="activity-grid" class="activity-grid">
                    <!-- Activity cards will be populated by JavaScript -->
                    <div class="activity-card" data-activity="fitness">
                        <div class="icon">🏃</div>
                        <div class="title">Fitness</div>
                        <div class="status">Tap to log</div>
                    </div>
                    <div class="activity-card" data-activity="cricket_coaching">
                        <div class="icon">🏏</div>
                        <div class="title">Cricket</div>
                        <div class="status">Tap to log</div>
                    </div>
                    <div class="activity-card" data-activity="cricket_match">
                        <div class="icon">🏆</div>
                        <div class="title">Match</div>
                        <div class="status">Tap to log</div>
                    </div>
                    <div class="activity-card" data-activity="rest_day">
                        <div class="icon">😴</div>
                        <div class="title">Rest Day</div>
                        <div class="status">Tap to log</div>
                    </div>
                </div>
            </section>

            <!-- Quick Stats -->
            <section class="card">
                <h2>📊 Quick Stats</h2>
                <div id="quick-stats" class="quick-stats">
                    <!-- Stats will be populated by JavaScript -->
                    <div class="stat-item">
                        <span class="stat-value">-</span>
                        <div class="stat-label">Fitness sessions</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">-</span>
                        <div class="stat-label">Cricket sessions</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">-</span>
                        <div class="stat-label">Energy level</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">-</span>
                        <div class="stat-label">Weekly goal</div>
                    </div>
                </div>
            </section>

            <!-- Progress Indicators -->
            <section class="card">
                <div id="progress-section" class="progress-section">
                    <h3>📈 This Week's Progress</h3>
                    
                    <div class="progress-item">
                        <div class="progress-text">
                            <span>Fitness Sessions</span>
                            <span id="fitness-progress-text">-/7 days</span>
                        </div>
                        <div class="progress-bar">
                            <div id="fitness-progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="progress-item">
                        <div class="progress-text">
                            <span>Cricket Practice</span>
                            <span id="cricket-progress-text">-/5 sessions</span>
                        </div>
                        <div class="progress-bar">
                            <div id="cricket-progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="card">
                <div id="recent-activity">
                    <h3>📋 Recent Activity</h3>
                    <div class="empty-state">
                        <p>Loading recent activities...</p>
                    </div>
                </div>
            </section>

            <!-- Refresh Button -->
            <button id="refresh-dashboard" class="btn full-width" style="margin-top: var(--spacing-lg);">
                🔄 Refresh Dashboard
            </button>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <section class="card">
                <h2>📊 Performance Analytics</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Visualize your cricket and fitness progress with interactive charts
                </p>
                
                <!-- Analytics Type Selector -->
                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); flex-wrap: wrap;">
                    <button class="btn" onclick="loadFitnessCharts()" style="flex: 1; min-width: 120px;">
                        🏃 Fitness Charts
                    </button>
                    <button class="btn" onclick="loadCricketCharts()" style="flex: 1; min-width: 120px;">
                        🏏 Cricket Charts
                    </button>
                    <button class="btn" onclick="loadCombinedCharts()" style="flex: 1; min-width: 120px;">
                        🔄 Combined View
                    </button>
                </div>
                
                <!-- Loading Indicator for Charts -->
                <div id="charts-loading" class="hidden" style="text-align: center; padding: var(--spacing-xl);">
                    <div class="loading"></div>
                    <p style="margin-top: var(--spacing-md); color: var(--text-secondary);">
                        Loading analytics charts...
                    </p>
                </div>
                
                <!-- Charts will be dynamically inserted here -->
            </section>
        </div>

        <!-- Entries Tab -->
        <div id="entries-tab" class="tab-content hidden">
            <section class="card">
                <h2>📋 Your Activity Log</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Browse through your logged activities
                </p>
                
                <div class="api-section">
                    <div>
                        <h3 style="margin-bottom: 12px; color: var(--primary-color);">Fitness Entries</h3>
                        <button class="btn" onclick="loadFitnessEntries()">🏃 Load Fitness Entries</button>
                        <div id="fitness-entries-response" class="response-area hidden"></div>
                    </div>
                    <div style="margin-top: var(--spacing-lg);">
                        <h3 style="margin-bottom: 12px; color: var(--primary-color);">Cricket Sessions</h3>
                        <button class="btn" onclick="loadCricketCoaching()">🏏 Load Coaching Sessions</button>
                        <div id="cricket-coaching-response" class="response-area hidden"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content hidden">
            <section class="card">
                <h2>🤖 AI Cricket Coach</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Get personalized insights and cricket advice
                </p>
                
                <div id="chat-interface" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">🤖</div>
                        <p>AI Chat Interface</p>
                        <p style="font-size: 0.9rem; margin-top: var(--spacing-sm);">
                            Coming soon! Your cricket coach powered by AI.
                        </p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden" style="text-align: center; padding: var(--spacing-lg);">
            <div class="loading"></div>
            <span>Loading...</span>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden status error" style="margin: var(--spacing-lg) 0;">
            Error message will appear here
        </div>
    </div>

    <!-- Voice Recording Modal -->
    <div id="voice-modal" class="voice-modal hidden">
        <div class="voice-content">
            <h3 id="voice-title">🎤 Voice Recording</h3>
            <p id="voice-description" style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                Speak naturally about your activity
            </p>
            
            <button id="record-btn" class="record-btn">🎤</button>
            
            <div id="status-message" class="status info">
                Click the microphone to start recording
            </div>
            
            <div id="transcript-display" class="hidden" style="background: var(--background-light); padding: var(--spacing-md); border-radius: var(--border-radius-sm); margin: var(--spacing-md) 0; text-align: left;">
                <strong>Transcript:</strong>
                <p id="transcript-text" style="margin-top: var(--spacing-sm); font-style: italic;"></p>
            </div>
            
            <div id="processed-data" class="hidden" style="background: #f0f9ff; padding: var(--spacing-md); border-radius: var(--border-radius-sm); margin: var(--spacing-md) 0; text-align: left; border: 1px solid #0ea5e9;">
                <strong>Processed Data:</strong>
                <pre id="processed-data-content" style="margin-top: var(--spacing-sm); font-size: 0.8rem; white-space: pre-wrap;"></pre>
            </div>
            
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                <button class="btn secondary" onclick="closeVoiceModal()">Cancel</button>
                <button class="btn" onclick="closeVoiceModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Scripts -->
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/charts.js"></script>
    <script>
        // Global variables for voice interface integration
        let currentEntryType = 'fitness';
        let socket = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioStream = null;
        let currentSessionId = 'session_' + Date.now();

        // Voice modal functions
        function openVoiceModal(entryType) {
            currentEntryType = entryType;
            const modal = document.getElementById('voice-modal');
            const title = document.getElementById('voice-title');
            const description = document.getElementById('voice-description');
            
            const titles = {
                'fitness': '🏃 Log Fitness Activity',
                'cricket_coaching': '🏏 Log Cricket Practice',
                'cricket_match': '🏆 Log Match Performance', 
                'rest_day': '😴 Log Rest Day'
            };
            
            const descriptions = {
                'fitness': 'Tell me about your workout, running, or fitness activity',
                'cricket_coaching': 'Describe your cricket practice session and what you worked on',
                'cricket_match': 'Share details about your match performance and how it went',
                'rest_day': 'Let me know how your rest day went and how you\'re feeling'
            };
            
            title.textContent = titles[entryType] || '🎤 Voice Recording';
            description.textContent = descriptions[entryType] || 'Speak naturally about your activity';
            
            modal.classList.remove('hidden');
            
            // Connect WebSocket if not already connected
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                connectWebSocket();
            }
        }

        function closeVoiceModal() {
            const modal = document.getElementById('voice-modal');
            modal.classList.add('hidden');
            
            // Stop recording if active
            if (isRecording) {
                stopRecording();
            }
            
            // Reset UI
            resetVoiceUI();
        }

        function resetVoiceUI() {
            document.getElementById('status-message').textContent = 'Click the microphone to start recording';
            document.getElementById('status-message').className = 'status info';
            document.getElementById('transcript-display').classList.add('hidden');
            document.getElementById('processed-data').classList.add('hidden');
            document.getElementById('record-btn').classList.remove('recording');
            document.getElementById('record-btn').textContent = '🎤';
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/voice/${currentSessionId}`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                updateStatus('Connected! Ready to record', 'success');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            socket.onclose = function() {
                updateStatus('Connection closed', 'info');
            };
            
            socket.onerror = function() {
                updateStatus('Connection error', 'error');
            };
        }

        function handleWebSocketMessage(data) {
            console.log('WebSocket message:', data);
            
            switch(data.type) {
                case 'connection_established':
                    updateStatus('Connected! Click microphone to record', 'success');
                    break;
                    
                case 'voice_meta_received':
                    updateStatus('Ready to record audio...', 'info');
                    break;
                    
                case 'audio_chunk_received':
                    updateStatus(`Recording... (${data.data.total_accumulated} bytes)`, 'info');
                    break;
                    
                case 'transcript_ready':
                    showTranscript(data.data.transcript);
                    updateStatus('Processing data...', 'info');
                    break;
                    
                case 'conversation_started':
                    updateStatus(`✅ ${data.data.message}`, 'success');
                    break;
                    
                case 'follow_up_question':
                    handleFollowUpQuestion(data.data);
                    break;
                    
                case 'conversation_completed':
                    handleConversationCompleted(data.data);
                    break;
                    
                case 'voice_processed_complete':
                    // Legacy support for single-turn processing
                    showProcessedData(data.data);
                    updateStatus(`✅ Entry saved! ID: ${data.data.saved_entry_id}`, 'success');
                    
                    // Refresh dashboard after successful entry
                    setTimeout(() => {
                        if (window.mobileDashboard) {
                            window.mobileDashboard.loadDashboardData();
                        }
                    }, 1500);
                    break;
                    
                case 'error':
                    updateStatus(`❌ Error: ${data.message}`, 'error');
                    break;
            }
        }

        function handleFollowUpQuestion(questionData) {
            console.log('Follow-up question received:', questionData);
            
            // Update status with question
            updateStatus(`❓ ${questionData.question}`, 'info');
            
            // Show the question prominently in the UI
            const statusEl = document.getElementById('status-message');
            statusEl.innerHTML = `
                <div style="text-align: left;">
                    <strong>Follow-up Question (${questionData.turn_number + 1}):</strong><br>
                    <em>"${questionData.question}"</em><br><br>
                    <small>Collecting: ${questionData.field_target.replace('_', ' ')}<br>
                    Progress: ${Math.round(questionData.completeness_score * 100)}% complete<br>
                    ${questionData.instructions}</small>
                </div>
            `;
            statusEl.className = 'status info';
            
            // Show collected data so far
            if (Object.keys(questionData.collected_data).length > 0) {
                showProcessedData({
                    structured_data: questionData.collected_data,
                    status: "collecting_more_data",
                    message: `Data collected so far (${Object.keys(questionData.collected_data).length} fields):`
                });
            }
            
            // Enable recording for the next response
            const recordBtn = document.getElementById('record-btn');
            recordBtn.disabled = false;
            recordBtn.classList.remove('recording');
            recordBtn.textContent = '🎤';
            
            // Highlight the record button to encourage response
            recordBtn.style.backgroundColor = 'var(--primary-color)';
            recordBtn.style.transform = 'scale(1.1)';
            setTimeout(() => {
                recordBtn.style.backgroundColor = '';
                recordBtn.style.transform = '';
            }, 2000);
            
            // Auto-scroll to keep question visible
            const modal = document.getElementById('voice-modal');
            modal.scrollTop = modal.scrollHeight;
        }

        function handleConversationCompleted(completionData) {
            console.log('Conversation completed:', completionData);
            
            // Show completion message
            updateStatus(`✅ ${completionData.message}`, 'success');
            
            // Show final structured data
            showProcessedData(completionData);
            
            // Show conversation metrics
            const statusEl = document.getElementById('status-message');
            statusEl.innerHTML = `
                <div style="text-align: left;">
                    <strong>✅ Conversation Complete!</strong><br>
                    ${completionData.message}<br><br>
                    <div style="background: #f0f9ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>📊 Session Metrics:</strong><br>
                        • Total turns: ${completionData.total_turns}<br>
                        • Data quality: ${Math.round(completionData.data_quality_score * 100)}%<br>
                        • Efficiency: ${Math.round(completionData.conversation_efficiency * 100)}%<br>
                        • Entry ID: ${completionData.saved_entry_id}
                    </div>
                    <small>You can close this modal or start a new recording.</small>
                </div>
            `;
            statusEl.className = 'status success';
            
            // Disable recording button
            const recordBtn = document.getElementById('record-btn');
            recordBtn.disabled = true;
            recordBtn.textContent = '✅';
            
            // Refresh dashboard after successful completion
            setTimeout(() => {
                if (window.mobileDashboard) {
                    window.mobileDashboard.loadDashboardData();
                }
            }, 2000);
            
            // Auto-close modal after 5 seconds
            setTimeout(() => {
                closeVoiceModal();
            }, 5000);
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function showTranscript(transcript) {
            const transcriptEl = document.getElementById('transcript-display');
            const transcriptText = document.getElementById('transcript-text');
            
            transcriptText.textContent = transcript;
            transcriptEl.classList.remove('hidden');
        }

        function showProcessedData(data) {
            const processedEl = document.getElementById('processed-data');
            const processedContent = document.getElementById('processed-data-content');
            
            processedContent.textContent = JSON.stringify(data.structured_data, null, 2);
            processedEl.classList.remove('hidden');
        }

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                // Send metadata first
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'voice_data_meta',
                        entry_type: currentEntryType,
                        user_id: 'demo_user'
                    }));
                }

                // Get microphone access
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                        socket.send(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'recording_complete'
                        }));
                    }
                };
                
                mediaRecorder.start(1000);
                isRecording = true;
                
                document.getElementById('record-btn').classList.add('recording');
                document.getElementById('record-btn').textContent = '⏹️';
                updateStatus('Recording... speak naturally', 'info');
                
            } catch (error) {
                console.error('Recording failed:', error);
                updateStatus('❌ Recording failed: ' + error.message, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Stop all tracks
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                
                document.getElementById('record-btn').classList.remove('recording');
                document.getElementById('record-btn').textContent = '🎤';
                updateStatus('Processing audio...', 'info');
            }
        }

        // Analytics Chart Functions
        function showChartsLoading() {
            const loadingEl = document.getElementById('charts-loading');
            if (loadingEl) {
                loadingEl.classList.remove('hidden');
            }
        }
        
        function hideChartsLoading() {
            const loadingEl = document.getElementById('charts-loading');
            if (loadingEl) {
                loadingEl.classList.add('hidden');
            }
        }

        // API Request Helper Function
        async function apiRequest(endpoint) {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                return JSON.stringify(data, null, 2);
            } catch (error) {
                return `Error: ${error.message}`;
            }
        }

        async function loadFitnessCharts() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<span class="loading"></span> Loading...';
            btn.disabled = true;
            showChartsLoading();
            
            try {
                if (window.analyticsCharts) {
                    await window.analyticsCharts.renderFitnessAnalytics();
                }
            } catch (error) {
                console.error('Failed to load fitness charts:', error);
            } finally {
                hideChartsLoading();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadCricketCharts() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<span class="loading"></span> Loading...';
            btn.disabled = true;
            showChartsLoading();
            
            try {
                if (window.analyticsCharts) {
                    await window.analyticsCharts.renderCricketAnalytics();
                }
            } catch (error) {
                console.error('Failed to load cricket charts:', error);
            } finally {
                hideChartsLoading();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadCombinedCharts() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<span class="loading"></span> Loading...';
            btn.disabled = true;
            showChartsLoading();
            
            try {
                if (window.analyticsCharts) {
                    await window.analyticsCharts.renderCombinedAnalytics();
                }
            } catch (error) {
                console.error('Failed to load combined charts:', error);
            } finally {
                hideChartsLoading();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadFitnessEntries() {
            const btn = event.target;
            const responseEl = document.getElementById('fitness-entries-response');
            
            btn.innerHTML = '<span class="loading"></span> Loading...';
            btn.disabled = true;
            
            responseEl.classList.remove('hidden');
            responseEl.textContent = await apiRequest('/api/entries/fitness');
            
            btn.innerHTML = '🏃 Load Fitness Entries';
            btn.disabled = false;
        }

        async function loadCricketCoaching() {
            const btn = event.target;
            const responseEl = document.getElementById('cricket-coaching-response');
            
            btn.innerHTML = '<span class="loading"></span> Loading...';
            btn.disabled = true;
            
            responseEl.classList.remove('hidden');
            responseEl.textContent = await apiRequest('/api/entries/cricket/coaching');
            
            btn.innerHTML = '🏏 Load Coaching Sessions';
            btn.disabled = false;
        }

        // Tab switching function
        function showTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab and content
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            const activeContent = document.getElementById(`${tabName}-tab`);
            
            if (activeTab && activeContent) {
                activeTab.classList.add('active');
                activeContent.classList.remove('hidden');
                
                // Auto-load charts when analytics tab is opened
                if (tabName === 'analytics') {
                    setTimeout(() => {
                        if (window.analyticsCharts && !activeContent.querySelector('.chart-container')) {
                            loadFitnessChartsAuto();
                        }
                    }, 300);
                }
            }
        }
        
        // Auto-load fitness charts when analytics tab opens
        async function loadFitnessChartsAuto() {
            showChartsLoading();
            try {
                if (window.analyticsCharts) {
                    await window.analyticsCharts.renderFitnessAnalytics();
                }
            } catch (error) {
                console.error('Failed to auto-load fitness charts:', error);
            } finally {
                hideChartsLoading();
            }
        }

        // Set up record button click handler
        document.addEventListener('DOMContentLoaded', function() {
            const recordBtn = document.getElementById('record-btn');
            recordBtn.addEventListener('click', toggleRecording);

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    showTab(tabName);
                });
            });

            console.log('🏏 Cricket Fitness Tracker Enhanced loaded');
            console.log('Mobile-first interface with working voice recording');
        });
    </script>
</body>
</html> 