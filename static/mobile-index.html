<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>🏏 Cricket Fitness Tracker</title>
    <meta name="description" content="Voice-powered cricket fitness tracking for young athletes">
    <meta name="theme-color" content="#4f46e5">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cricket Tracker">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/mobile-first.css">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/static/js/dashboard.js" as="script">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🏏 Cricket Fitness Tracker</h1>
            <p>Voice-powered tracking for young athletes</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="nav-tab" data-tab="analytics">📊 Analytics</button>
            <button class="nav-tab" data-tab="entries">📋 Entries</button>
            <button class="nav-tab" data-tab="chat">🤖 AI Coach</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <!-- Activity Logging Cards -->
            <section class="card">
                <h2>📝 Log Today's Activities</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Tap an activity to start voice logging
                </p>
                
                <div id="activity-grid" class="activity-grid">
                    <!-- Activity cards will be populated by JavaScript -->
                    <div class="activity-card" data-activity="fitness">
                        <div class="icon">🏃</div>
                        <div class="title">Fitness</div>
                        <div class="status">Tap to log</div>
                    </div>
                    <div class="activity-card" data-activity="cricket_coaching">
                        <div class="icon">🏏</div>
                        <div class="title">Cricket</div>
                        <div class="status">Tap to log</div>
                    </div>
                    <div class="activity-card" data-activity="cricket_match">
                        <div class="icon">🏆</div>
                        <div class="title">Match</div>
                        <div class="status">Tap to log</div>
                    </div>
                    <div class="activity-card" data-activity="rest_day">
                        <div class="icon">😴</div>
                        <div class="title">Rest Day</div>
                        <div class="status">Tap to log</div>
                    </div>
                </div>
            </section>

            <!-- Quick Stats -->
            <section class="card">
                <h2>📊 Quick Stats</h2>
                <div id="quick-stats" class="quick-stats">
                    <!-- Stats will be populated by JavaScript -->
                    <div class="stat-item">
                        <span class="stat-value">0/7</span>
                        <div class="stat-label">Fitness sessions</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0</span>
                        <div class="stat-label">Cricket sessions</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0/5</span>
                        <div class="stat-label">Energy level</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">0%</span>
                        <div class="stat-label">Weekly goal</div>
                    </div>
                </div>
            </section>

            <!-- Progress Indicators -->
            <section class="card">
                <div id="progress-section" class="progress-section">
                    <h3>📈 This Week's Progress</h3>
                    
                    <div class="progress-item">
                        <div class="progress-text">
                            <span>Fitness Sessions</span>
                            <span>0/7 days</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="progress-item">
                        <div class="progress-text">
                            <span>Cricket Practice</span>
                            <span>0/5 sessions</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="card">
                <div id="recent-activity">
                    <h3>📋 Recent Activity</h3>
                    <div class="empty-state">
                        <p>No recent activities. Start logging your fitness and cricket sessions!</p>
                    </div>
                </div>
            </section>

            <!-- Refresh Button -->
            <button id="refresh-dashboard" class="btn full-width" style="margin-top: var(--spacing-lg);">
                🔄 Refresh Dashboard
            </button>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <section class="card">
                <h2>📊 Performance Analytics</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Visual insights into your cricket and fitness progress
                </p>
                
                <!-- Chart containers will be added here -->
                <div class="chart-container">
                    <canvas id="fitness-chart" width="400" height="200"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="cricket-chart" width="400" height="200"></canvas>
                </div>
                
                <p style="text-align: center; color: var(--text-secondary); font-style: italic;">
                    📈 Charts will be implemented in Phase 1 of development
                </p>
            </section>
        </div>

        <!-- Entries Tab -->
        <div id="entries-tab" class="tab-content hidden">
            <section class="card">
                <h2>📋 Your Activity Log</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Browse through your logged activities
                </p>
                
                <div id="entries-list">
                    <!-- Entries will be populated by JavaScript -->
                    <p style="text-align: center; color: var(--text-secondary); font-style: italic;">
                        📝 Enhanced entry display will be implemented in Phase 1
                    </p>
                </div>
            </section>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content hidden">
            <section class="card">
                <h2>🤖 AI Cricket Coach</h2>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                    Get personalized insights and cricket advice
                </p>
                
                <div id="chat-interface" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">🤖</div>
                        <p>AI Chat Interface</p>
                        <p style="font-size: 0.9rem; margin-top: var(--spacing-sm);">
                            Coming in Phase 2 of development
                        </p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden" style="text-align: center; padding: var(--spacing-lg);">
            <div class="loading"></div>
            <span>Loading...</span>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden status error" style="margin: var(--spacing-lg) 0;">
            Error message will appear here
        </div>
    </div>

    <!-- Voice Recording Modal -->
    <div id="voice-modal" class="voice-modal hidden">
        <div class="voice-content">
            <h3 id="voice-title">🎤 Voice Recording</h3>
            <p id="voice-description" style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                Speak naturally about your activity
            </p>
            
            <button id="record-btn" class="record-btn">🎤</button>
            
            <div id="status-message" class="status info">
                Click the microphone to start recording
            </div>
            
            <div id="transcript-display" class="hidden" style="background: var(--background-light); padding: var(--spacing-md); border-radius: var(--border-radius-sm); margin: var(--spacing-md) 0; text-align: left;">
                <strong>Transcript:</strong>
                <p id="transcript-text" style="margin-top: var(--spacing-sm); font-style: italic;"></p>
            </div>
            
            <div id="processed-data" class="hidden" style="background: #f0f9ff; padding: var(--spacing-md); border-radius: var(--border-radius-sm); margin: var(--spacing-md) 0; text-align: left; border: 1px solid #0ea5e9;">
                <strong>Processed Data:</strong>
                <pre id="processed-data-content" style="margin-top: var(--spacing-sm); font-size: 0.8rem; white-space: pre-wrap;"></pre>
            </div>
            
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                <button class="btn secondary" onclick="closeVoiceModal()">Cancel</button>
                <button class="btn" onclick="closeVoiceModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/dashboard.js"></script>
    <script>
        // Global variables for voice interface integration
        let currentEntryType = 'fitness';
        let socket = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioStream = null;
        let currentSessionId = 'session_' + Date.now();

        // Voice modal functions
        function openVoiceModal(entryType) {
            currentEntryType = entryType;
            const modal = document.getElementById('voice-modal');
            const title = document.getElementById('voice-title');
            const description = document.getElementById('voice-description');
            
            const titles = {
                'fitness': '🏃 Log Fitness Activity',
                'cricket_coaching': '🏏 Log Cricket Practice',
                'cricket_match': '🏆 Log Match Performance', 
                'rest_day': '😴 Log Rest Day'
            };
            
            const descriptions = {
                'fitness': 'Tell me about your workout, running, or fitness activity',
                'cricket_coaching': 'Describe your cricket practice session and what you worked on',
                'cricket_match': 'Share details about your match performance and how it went',
                'rest_day': 'Let me know how your rest day went and how you\'re feeling'
            };
            
            title.textContent = titles[entryType] || '🎤 Voice Recording';
            description.textContent = descriptions[entryType] || 'Speak naturally about your activity';
            
            // Reset conversation state for new activity type
            resetConversationState();
            
            modal.classList.remove('hidden');
            
            // Connect WebSocket if not already connected
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                connectWebSocket();
            }
            
            // Send metadata immediately to prepare backend for new activity type
            setTimeout(() => {
                sendSessionMetadata();
            }, 500);
        }

        /**
         * Send session metadata to backend to prepare for new activity type
         */
        function sendSessionMetadata() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                console.log(`📤 Sending session metadata for activity type: ${currentEntryType}`);
                socket.send(JSON.stringify({
                    type: 'voice_data_meta',
                    entry_type: currentEntryType,
                    user_id: '050c4886-de5f-43bc-a509-ac8b9567e170'
                }));
            } else {
                console.warn('⚠️ WebSocket not ready, will send metadata when recording starts');
            }
        }

        /**
         * Reset conversation state when switching activity types
         */
        function resetConversationState() {
            console.log('🔄 Resetting conversation state for new activity type');
            
            // Reset any conversation UI elements if they exist
            const transcriptDisplay = document.getElementById('transcript-display');
            if (transcriptDisplay) {
                transcriptDisplay.classList.add('hidden');
                transcriptDisplay.innerHTML = '';
            }
            
            const processedData = document.getElementById('processed-data');
            if (processedData) {
                processedData.classList.add('hidden');
                processedData.innerHTML = '';
            }
            
            // Reset status message to initial state
            if (typeof updateStatus === 'function') {
                updateStatus('Click the microphone to start recording', 'info');
            }
            
            // Reset recording UI state
            resetVoiceUI();
            
            console.log('✅ Conversation state reset complete');
        }

        function closeVoiceModal() {
            const modal = document.getElementById('voice-modal');
            modal.classList.add('hidden');
            
            // Stop recording if active
            if (isRecording) {
                stopRecording();
            }
            
            // Reset UI
            resetVoiceUI();
        }

        function resetVoiceUI() {
            document.getElementById('status-message').textContent = 'Click the microphone to start recording';
            document.getElementById('status-message').className = 'status info';
            document.getElementById('transcript-display').classList.add('hidden');
            document.getElementById('processed-data').classList.add('hidden');
            document.getElementById('record-btn').classList.remove('recording');
            document.getElementById('record-btn').textContent = '🎤';
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/voice/${currentSessionId}`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                updateStatus('Connected! Ready to record', 'success');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            socket.onclose = function() {
                updateStatus('Connection closed', 'info');
            };
            
            socket.onerror = function() {
                updateStatus('Connection error', 'error');
            };
        }

        function handleWebSocketMessage(data) {
            console.log('WebSocket message:', data);
            
            switch(data.type) {
                case 'connection_established':
                    updateStatus('Connected! Click microphone to record', 'success');
                    break;
                    
                case 'voice_meta_received':
                    updateStatus('Ready to record audio...', 'info');
                    break;
                    
                case 'audio_chunk_received':
                    updateStatus(`Recording... (${data.data.total_accumulated} bytes)`, 'info');
                    break;
                    
                case 'transcript_ready':
                    showTranscript(data.data.transcript);
                    updateStatus('Processing data...', 'info');
                    break;
                    
                case 'voice_processed_complete':
                    showProcessedData(data.data);
                    updateStatus(`✅ Entry saved! ID: ${data.data.saved_entry_id}`, 'success');
                    
                    // Refresh dashboard after successful entry
                    setTimeout(() => {
                        if (window.mobileDashboard) {
                            window.mobileDashboard.loadDashboardData();
                        }
                    }, 1000);
                    break;
                    
                case 'error':
                    updateStatus(`❌ Error: ${data.message}`, 'error');
                    break;
            }
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function showTranscript(transcript) {
            const transcriptEl = document.getElementById('transcript-display');
            const transcriptText = document.getElementById('transcript-text');
            
            transcriptText.textContent = transcript;
            transcriptEl.classList.remove('hidden');
        }

        function showProcessedData(data) {
            const processedEl = document.getElementById('processed-data');
            const processedContent = document.getElementById('processed-data-content');
            
            processedContent.textContent = JSON.stringify(data.structured_data, null, 2);
            processedEl.classList.remove('hidden');
        }

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                // Send metadata first
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'voice_data_meta',
                        entry_type: currentEntryType,
                        user_id: 'demo_user'
                    }));
                }

                // Get microphone access
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                        socket.send(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'recording_complete'
                        }));
                    }
                };
                
                mediaRecorder.start(1000);
                isRecording = true;
                
                document.getElementById('record-btn').classList.add('recording');
                document.getElementById('record-btn').textContent = '⏹️';
                updateStatus('Recording... speak naturally', 'info');
                
            } catch (error) {
                console.error('Recording failed:', error);
                updateStatus('❌ Recording failed: ' + error.message, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Stop all tracks
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                
                document.getElementById('record-btn').classList.remove('recording');
                document.getElementById('record-btn').textContent = '🎤';
                updateStatus('Processing audio...', 'info');
            }
        }

        // Set up record button click handler
        document.addEventListener('DOMContentLoaded', function() {
            const recordBtn = document.getElementById('record-btn');
            recordBtn.addEventListener('click', toggleRecording);
        });
    </script>
</body>
</html> 